name: Playwright Tests

on:
  push:
    branches: [main, master, gergo_test_branch]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 3 * * 0' # Every Sunday at 3 AM UTC - clear history

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  test:
    name: Run Tests (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Install Playwright browsers
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # Step 5: Restore Allure history from gh-pages branch
      - name: Checkout gh-pages for history
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages-checkout

      - name: Restore branch-specific history
        if: ${{ github.event_name != 'schedule' }}
        run: |
          HISTORY_FOLDER="gh-pages-checkout/${{ github.ref_name }}-allure-report/history"
          if [ -d "$HISTORY_FOLDER" ]; then
            echo "ðŸ“‹ Restoring Allure history for branch: ${{ github.ref_name }}"
            mkdir -p allure-results/history
            cp -R "$HISTORY_FOLDER"/* allure-results/history/
            echo "âœ… History restored successfully"
          else
            echo "â„¹ï¸  No previous history found for this branch (first run)"
          fi
          rm -rf gh-pages-checkout

      # Step 6: Clear history on Sunday
      - name: Clear Allure history (Sunday cleanup)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          echo "ðŸ§¹ Sunday cleanup: Clearing Allure history..."
          rm -rf allure-results allure-report

      # Step 7: Run ESLint
      - name: Run ESLint
        run: npm run lint

      # Step 8: Check code formatting
      - name: Check code formatting
        run: npm run format

      # Step 9: Run tests
      - name: Run Playwright tests
        run: npx playwright test --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
        continue-on-error: true

      # Step 8: Create executor.json for history tracking
      - name: Create executor.json
        if: ${{ !cancelled() }}
        run: |
          echo "ðŸ“ Creating executor.json for history tracking..."
          cat > allure-results/executor.json << EOF
          {
            "name": "GitHub Actions",
            "type": "github",
            "buildOrder": ${{ github.run_number }},
            "buildName": "Run #${{ github.run_number }}",
            "buildUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "reportUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.ref_name }}-allure-report/",
            "reportName": "Allure Report - Run #${{ github.run_number }}"
          }
          EOF
          echo "âœ… Executor file created with buildOrder: ${{ github.run_number }}"

      # Step 9: Verify history data
      - name: Verify Allure history
        if: ${{ !cancelled() && github.event_name != 'schedule' }}
        run: |
          if [ -d allure-results/history ]; then
            echo "âœ… Allure history available for trend analysis"
            ls -la allure-results/history/ | head -10
          else
            echo "â„¹ï¸  No previous history - this will be the baseline run"
          fi

      # Step 10: Generate Allure report
      - name: Generate Allure report
        if: ${{ !cancelled() }}
        run: npx allure generate allure-results -o allure-report --clean

      # Step 11: Verify generated report
      - name: Verify generated report
        if: ${{ !cancelled() }}
        run: |
          echo "ðŸ“Š Allure report generated successfully"
          ls -la allure-report/

      # Step 12: Prepare GitHub Pages deployment
      - name: Prepare GitHub Pages content
        if: ${{ !cancelled() }}
        run: |
          echo "ðŸ“¦ Preparing GitHub Pages deployment..."
          rm -rf gh-pages-deploy
          mkdir -p gh-pages-deploy/${{ github.ref_name }}-allure-report

          # Copy Allure report to branch-specific folder
          cp -R allure-report/* gh-pages-deploy/${{ github.ref_name }}-allure-report/

          # Allure 2.x: History is stored in allure-report/history
          # It will be automatically restored in the next run
          if [ -d allure-report/history ]; then
            echo "ðŸ’¾ History folder preserved in report (Allure 2.x)"
            echo "ðŸ“Š Branch: ${{ github.ref_name }}"
          else
            echo "â„¹ï¸  First run - history will be created for next run"
          fi

          # Add .nojekyll to prevent Jekyll processing
          touch gh-pages-deploy/.nojekyll

          # Create index.html that redirects to the branch report
          cat > gh-pages-deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <meta http-equiv="refresh" content="0; url=./${{ github.ref_name }}-allure-report/">
              <title>Allure Reports - Redirecting...</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      height: 100vh;
                      margin: 0;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  .container {
                      text-align: center;
                      padding: 2rem;
                      background: rgba(255,255,255,0.1);
                      border-radius: 10px;
                      backdrop-filter: blur(10px);
                  }
                  h1 { margin: 0 0 1rem 0; }
                  p { margin: 0.5rem 0; }
                  a { color: #ffd700; text-decoration: none; font-weight: bold; }
                  a:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸ“Š Allure Test Reports</h1>
                  <p>Redirecting to branch: <strong>${{ github.ref_name }}</strong></p>
                  <p>If not redirected, <a href="./${{ github.ref_name }}-allure-report/">click here</a></p>
              </div>
          </body>
          </html>
          EOF

          echo "âœ… GitHub Pages content ready"

      # Publish test results from JUnit XML
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: ${{ !cancelled() }}
        with:
          files: test-results/junit.xml
          check_name: Playwright Test Results

      # Artifact 1: Playwright Report
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-${{ github.ref_name }}-${{ matrix.shardIndex }}
          path: playwright-report/
          retention-days: 30

      # Artifact 2: Allure Results (not report, we'll merge later)
      - name: Upload Allure Results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: allure-results-${{ github.ref_name }}-${{ matrix.shardIndex }}
          path: allure-results/
          retention-days: 1

  merge-reports:
    name: ðŸ“Š Merge Reports & Deploy
    needs: test
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Download all Allure results from shards
      - name: Download all Allure results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-${{ github.ref_name }}-*
          path: allure-results-shards
          merge-multiple: true

      # Step 5: Merge all shard results into one folder
      - name: Merge Allure results
        run: |
          echo "ðŸ“¦ Merging Allure results from all shards..."
          mkdir -p allure-results
          find allure-results-shards -type f -name "*.json" -exec cp {} allure-results/ \;
          echo "âœ… Merged $(find allure-results -type f -name "*.json" | wc -l) result files"

      # Step 6: Restore Allure history from gh-pages branch
      - name: Checkout gh-pages for history
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages-checkout

      - name: Restore branch-specific history
        if: ${{ github.event_name != 'schedule' }}
        run: |
          HISTORY_FOLDER="gh-pages-checkout/${{ github.ref_name }}-allure-report/history"
          if [ -d "$HISTORY_FOLDER" ]; then
            echo "ðŸ“‹ Restoring Allure history for branch: ${{ github.ref_name }}"
            mkdir -p allure-results/history
            cp -R "$HISTORY_FOLDER"/* allure-results/history/
            echo "âœ… History restored successfully"
          else
            echo "â„¹ï¸  No previous history found for this branch (first run)"
          fi
          rm -rf gh-pages-checkout

      # Step 7: Create executor.json for history tracking
      - name: Create executor.json
        run: |
          echo "ðŸ“ Creating executor.json for history tracking..."
          cat > allure-results/executor.json << EOF
          {
            "name": "GitHub Actions",
            "type": "github",
            "buildOrder": ${{ github.run_number }},
            "buildName": "Run #${{ github.run_number }}",
            "buildUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "reportUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.ref_name }}-allure-report/",
            "reportName": "Allure Report - Run #${{ github.run_number }}"
          }
          EOF
          echo "âœ… Executor file created with buildOrder: ${{ github.run_number }}"

      # Step 8: Generate merged Allure report
      - name: Generate Allure report
        run: npx allure generate allure-results -o allure-report --clean

      # Step 9: Verify generated report
      - name: Verify generated report
        run: |
          echo "ðŸ“Š Allure report generated successfully"
          ls -la allure-report/

      # Step 10: Prepare GitHub Pages deployment
      - name: Prepare GitHub Pages content
        run: |
          echo "ðŸ“¦ Preparing GitHub Pages deployment..."
          rm -rf gh-pages-deploy
          mkdir -p gh-pages-deploy/${{ github.ref_name }}-allure-report

          # Copy Allure report to branch-specific folder
          cp -R allure-report/* gh-pages-deploy/${{ github.ref_name }}-allure-report/

          # Add .nojekyll to prevent Jekyll processing
          touch gh-pages-deploy/.nojekyll

          # Create index.html that redirects to the branch report
          cat > gh-pages-deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <meta http-equiv="refresh" content="0; url=./${{ github.ref_name }}-allure-report/">
              <title>Allure Reports - Redirecting...</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      height: 100vh;
                      margin: 0;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  .container {
                      text-align: center;
                      padding: 2rem;
                      background: rgba(255,255,255,0.1);
                      border-radius: 10px;
                      backdrop-filter: blur(10px);
                  }
                  h1 { margin: 0 0 1rem 0; }
                  p { margin: 0.5rem 0; }
                  a { color: #ffd700; text-decoration: none; font-weight: bold; }
                  a:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸ“Š Allure Test Reports</h1>
                  <p>Redirecting to branch: <strong>${{ github.ref_name }}</strong></p>
                  <p>If not redirected, <a href="./${{ github.ref_name }}-allure-report/">click here</a></p>
              </div>
          </body>
          </html>
          EOF

          echo "âœ… GitHub Pages content ready"

      # Step 11: Upload merged Allure Report as artifact
      - name: Upload merged Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.ref_name }}
          path: allure-report/
          retention-days: 30

      # Step 12: Upload deployment package for deploy job
      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: gh-pages-deploy-${{ github.ref_name }}
          path: gh-pages-deploy/
          retention-days: 1

  deploy:
    name: ðŸ“Š Deploy Allure Report
    needs: merge-reports
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    environment:
      name: allure-report-${{ github.ref_name }}
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.ref_name }}-allure-report/
    steps:
      # Download deployment package from test job
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: gh-pages-deploy-${{ github.ref_name }}
          path: gh-pages-deploy

      # Deploy to gh-pages branch
      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          publish_branch: gh-pages
          keep_files: true
          destination_dir: .
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy Allure report from ${{ github.ref_name }}'

      # Display Allure Report link
      - name: ðŸ“Š Allure Report Link
        run: |
          echo "## ðŸ“Š Allure Report Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "ðŸ”— **View Report:** [https://${{ github.repository_owner }}.github.io/$REPO_NAME/${{ github.ref_name }}-allure-report/](https://${{ github.repository_owner }}.github.io/$REPO_NAME/${{ github.ref_name }}-allure-report/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Report deployed successfully for branch: **${{ github.ref_name }}**" >> $GITHUB_STEP_SUMMARY
