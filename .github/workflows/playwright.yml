name: Playwright Tests

on:
  push:
    branches: [main, master, gergo_test_branch]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 3 * * 0' # Every Sunday at 3 AM UTC - clear history

permissions:
  contents: read
  pages: write
  id-token: write
  checks: write
  pull-requests: write

jobs:
  test:
    name: Run Tests & Generate Reports
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Install Playwright browsers
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # Step 5: Restore Allure history (skip on Sunday cleanup)
      - name: Download previous Allure history
        if: ${{ github.event_name != 'schedule' }}
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          name: allure-history
          path: .allure
          workflow: playwright.yml
          branch: gergo_test_branch

      # Step 6: Clear history on Sunday
      - name: Clear Allure history (Sunday cleanup)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          echo "ðŸ§¹ Sunday cleanup: Clearing Allure history..."
          rm -rf .allure allure-results allure-report
          mkdir -p .allure/history

      # Step 7: Run tests
      - name: Run Playwright tests
        run: npx playwright test
        continue-on-error: true

      # Step 8: Merge previous history into results
      - name: Merge Allure history
        if: ${{ !cancelled() && github.event_name != 'schedule' }}
        run: |
          if [ -d .allure/history ]; then
            echo "ðŸ“‹ Copying previous Allure history..."
            mkdir -p allure-results
            cp -R .allure/history allure-results/
          else
            echo "No previous history found"
          fi

      # Step 9: Generate Allure report
      - name: Generate Allure report
        if: ${{ !cancelled() }}
        run: npx allure@latest generate allure-results -o allure-report

      # Step 10: Save new history
      - name: Save Allure history
        if: ${{ !cancelled() }}
        run: |
          mkdir -p .allure
          if [ -d allure-report/history ]; then
            echo "ðŸ’¾ Saving Allure history..."
            rm -rf .allure/history
            cp -R allure-report/history .allure/
          fi

      # Step 11: Prepare GitHub Pages artifact
      - name: Prepare GitHub Pages content
        if: ${{ !cancelled() }}
        run: |
          echo "ðŸ“¦ Preparing GitHub Pages artifact..."
          rm -rf gh-pages-deploy
          mkdir -p gh-pages-deploy

          # Copy Allure report
          cp -R allure-report/* gh-pages-deploy/

          # Copy Allure history
          if [ -d .allure ]; then
            mkdir -p gh-pages-deploy/.allure
            cp -R .allure/* gh-pages-deploy/.allure/
          fi

          # Add .nojekyll to prevent Jekyll processing
          touch gh-pages-deploy/.nojekyll

          echo "âœ… GitHub Pages content ready:"
          ls -la gh-pages-deploy/

      # Step 12: Generate test summary
      - name: Generate test summary
        if: ${{ !cancelled() }}
        run: |
          echo "## ðŸ“Š Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.json ]; then
            TOTAL=$(jq '.suites[].specs | length' test-results.json | awk '{s+=$1} END {print s}')
            echo "- **Total Tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f allure-report/widgets/summary.json ]; then
            echo "- **Report:** [View Allure Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Artifacts Available:" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸŽ­ Playwright HTML Report" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ“Š Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸŒ GitHub Pages (deployed)" >> $GITHUB_STEP_SUMMARY

      # Artifact 1: Playwright Report
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      # Artifact 2: Allure Report
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      # Artifact 3: Allure History
      - name: Upload Allure History
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: allure-history
          path: .allure/
          retention-days: 30

      # Artifact 4: GitHub Pages
      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        if: ${{ !cancelled() }}
        with:
          path: gh-pages-deploy/

  # Deploy job
  deploy:
    name: Deploy to GitHub Pages
    needs: test
    if: ${{ !cancelled() && github.ref == 'refs/heads/gergo_test_branch' }}
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Add deployment info to summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Allure Report URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
