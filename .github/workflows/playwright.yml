name: Playwright Tests

on:
  push:
    branches: [main, master, gergo_test_branch]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 3 * * 0' # Every Sunday at 3 AM UTC - clear history

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  test:
    name: Run Tests & Generate Reports
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Install Playwright browsers
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # Step 5: Restore Allure history from gh-pages branch
      - name: Checkout gh-pages for history
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages-checkout

      - name: Restore branch-specific history
        if: ${{ github.event_name != 'schedule' }}
        run: |
          BRANCH_FOLDER="gh-pages-checkout/${{ github.ref_name }}-allure-report/.allure"
          if [ -d "$BRANCH_FOLDER" ]; then
            echo "ðŸ“‹ Restoring history for branch: ${{ github.ref_name }}"
            mkdir -p .allure
            cp -R "$BRANCH_FOLDER"/* .allure/
          else
            echo "No previous history found for this branch"
            mkdir -p .allure/history
          fi
          rm -rf gh-pages-checkout

      # Step 6: Clear history on Sunday
      - name: Clear Allure history (Sunday cleanup)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          echo "ðŸ§¹ Sunday cleanup: Clearing Allure history..."
          rm -rf .allure allure-results allure-report
          mkdir -p .allure/history

      # Step 7: Run tests
      - name: Run Playwright tests
        run: npx playwright test
        continue-on-error: true

      # Step 8: Merge previous history into results
      - name: Merge Allure history
        if: ${{ !cancelled() && github.event_name != 'schedule' }}
        run: |
          if [ -d .allure/history ]; then
            echo "ðŸ“‹ Copying previous Allure history..."
            mkdir -p allure-results
            cp -R .allure/history allure-results/
          else
            echo "No previous history found"
          fi

      # Step 9: Generate Allure report
      - name: Generate Allure report
        if: ${{ !cancelled() }}
        run: npx allure@latest generate allure-results -o allure-report

      # Step 10: Save new history
      - name: Save Allure history
        if: ${{ !cancelled() }}
        run: |
          mkdir -p .allure
          if [ -d allure-report/history ]; then
            echo "ðŸ’¾ Saving Allure history..."
            rm -rf .allure/history
            cp -R allure-report/history .allure/
          fi

      # Step 11: Prepare GitHub Pages deployment
      - name: Prepare GitHub Pages content
        if: ${{ !cancelled() }}
        run: |
          echo "ðŸ“¦ Preparing GitHub Pages deployment..."
          rm -rf gh-pages-deploy
          mkdir -p gh-pages-deploy/${{ github.ref_name }}-allure-report

          # Copy Allure report to branch-specific folder
          cp -R allure-report/* gh-pages-deploy/${{ github.ref_name }}-allure-report/

          # Copy .allure history into branch folder
          mkdir -p gh-pages-deploy/${{ github.ref_name }}-allure-report/.allure
          cp -R .allure/* gh-pages-deploy/${{ github.ref_name }}-allure-report/.allure/
          echo "ðŸ’¾ History saved for branch: ${{ github.ref_name }}"

          # Add .nojekyll to prevent Jekyll processing
          touch gh-pages-deploy/.nojekyll

          echo "âœ… GitHub Pages content ready"

      # Step 12: Generate test summary
      - name: Generate test summary
        if: ${{ !cancelled() }}
        run: |
          echo "## ðŸ“Š Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.json ]; then
            TOTAL=$(jq '.suites[].specs | length' test-results.json | awk '{s+=$1} END {print s}')
            echo "- **Total Tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Artifacts Available:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ­ Playwright HTML Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Allure Report" >> $GITHUB_STEP_SUMMARY

      # Artifact 1: Playwright Report
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-${{ github.ref_name }}
          path: playwright-report/
          retention-days: 30

      # Artifact 2: Allure Report
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: allure-report-${{ github.ref_name }}
          path: allure-report/
          retention-days: 30

      # Step 13: Deploy to gh-pages branch
      - name: Deploy to gh-pages branch
        if: ${{ !cancelled() }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          publish_branch: gh-pages
          keep_files: true
          destination_dir: .
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy Allure report from ${{ github.ref_name }}'

      # Step 14: Add Allure Report link to summary
      - name: Add Allure Report link
        if: ${{ !cancelled() }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "ðŸ”— **View Report:** [https://${{ github.repository_owner }}.github.io/$REPO_NAME/${{ github.ref_name }}-allure-report/](https://${{ github.repository_owner }}.github.io/$REPO_NAME/${{ github.ref_name }}-allure-report/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Allure report deployed to GitHub Pages for branch: **${{ github.ref_name }}**" >> $GITHUB_STEP_SUMMARY
